<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="しろたんバス">
<meta name="theme-color" content="#7ec8e3">
<meta name="description" content="しろたんシャトルバス時刻表アプリ">
<link rel="apple-touch-icon" href="icon.png">
<link rel="icon" type="image/png" href="icon.png">
<link rel="manifest" href="manifest.json">
<title>しろたんバス</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
    --safe-t:env(safe-area-inset-top,0px);
    --safe-b:env(safe-area-inset-bottom,0px);
    --bg:#f2f2f7;
    --card:#fff;
    --text:#1c1c1e;
    --text2:#636366;
    --text3:#aeaeb2;
    --accent:#5ab4d6;
    --accent-bg:#7ec8e3;
    --accent-light:#d4eef7;
    --accent-grad:linear-gradient(135deg,#8ed4ee 0%,#5ab4d6 100%);
    --shadow:0 1px 3px rgba(0,0,0,.04);
    --shadow2:0 2px 12px rgba(0,0,0,.06);
    --r:16px;
    --r-sm:12px;
    --ease:cubic-bezier(.4,0,.2,1);
}
.mansion{
    --accent:#e8879f;--accent-bg:#f2b5c8;--accent-light:#fce4ec;
    --accent-grad:linear-gradient(135deg,#f5c4d4 0%,#e8879f 100%);
}

html,body{background:var(--bg);overflow-x:hidden}
body{
    font-family:'Nunito',-apple-system,system-ui,sans-serif;
    color:var(--text);
    -webkit-font-smoothing:antialiased;
    -webkit-tap-highlight-color:transparent;
    overscroll-behavior-y:none;
    min-height:100dvh;
}

/* ===== NAV BAR — paints behind Dynamic Island ===== */
.nav{
    position:fixed;top:0;left:0;right:0;z-index:50;
    background:var(--accent-grad);
    padding-top:max(var(--safe-t),20px);
    transition:background .4s var(--ease);
}
.nav-in{
    display:flex;align-items:center;justify-content:space-between;
    padding:10px 20px 12px;
}
.nav-left{display:flex;align-items:center;gap:10px}
.nav-icon{
    width:34px;height:34px;border-radius:10px;overflow:hidden;
    background:rgba(255,255,255,.3);flex-shrink:0;
}
.nav-icon img{width:100%;height:100%;object-fit:cover}
.nav-title{font-size:17px;font-weight:900;color:#fff}
.nav-right{display:flex;align-items:center;gap:10px}
.nav-clock{font-size:14px;font-weight:700;color:rgba(255,255,255,.8);font-variant-numeric:tabular-nums}
.nav-badge{
    display:flex;align-items:center;gap:4px;
    padding:4px 8px;border-radius:99px;font-size:10px;font-weight:800;
    background:rgba(255,255,255,.25);color:#fff;
}
.nav-badge.off{background:rgba(0,0,0,.15)}
.nav-dot{width:5px;height:5px;border-radius:50%;background:#fff}
.nav-badge.on .nav-dot{animation:blink 2s ease-in-out infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.3}}

/* ===== SCROLLABLE CONTENT ===== */
.main{
    padding-top:calc(max(var(--safe-t),20px) + 60px);
    padding-bottom:calc(var(--safe-b) + 76px);
    padding-left:16px;padding-right:16px;
    max-width:430px;margin:0 auto;
}

/* ===== HERO CARD ===== */
.hero{
    background:var(--card);border-radius:var(--r);
    padding:24px 20px;box-shadow:var(--shadow2);
    text-align:center;margin-bottom:12px;
    transition:opacity .28s var(--ease);
}
.hero.fade{opacity:0}
.hero-mascot{
    width:76px;height:76px;border-radius:50%;
    margin:0 auto 14px;overflow:hidden;
    background:var(--accent-light);
    box-shadow:0 4px 16px rgba(0,0,0,.08);
    border:3px solid #fff;
}
.hero-mascot img{width:100%;height:100%;object-fit:cover}
.hero-dir{
    display:inline-block;font-size:11px;font-weight:800;
    color:var(--accent);letter-spacing:.08em;margin-bottom:10px;
}
.hero-time{
    font-size:clamp(52px,15vw,72px);font-weight:900;
    letter-spacing:-.04em;line-height:.95;color:var(--text);
}
.hero-time.urgent{animation:pulse .8s ease-in-out infinite}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}
.hero-sub{
    margin-top:8px;font-size:14px;font-weight:600;color:var(--text2);
    display:flex;align-items:center;justify-content:center;gap:4px;
}
.hero-sub b{font-size:22px;font-weight:900;color:var(--accent)}
.hero-sub.urgent b{font-size:26px}
.hero-sub.now{color:var(--accent);font-weight:800}
.hero-tmrw{
    display:inline-block;font-size:9px;font-weight:800;
    background:var(--accent-light);color:var(--accent);
    padding:2px 7px;border-radius:5px;margin-left:4px;
}
.bar{
    width:140px;height:4px;margin:14px auto 0;
    background:rgba(0,0,0,.04);border-radius:99px;overflow:hidden;
}
.bar-fill{height:100%;border-radius:99px;background:var(--accent-grad);transition:width 1s linear}

/* upcoming */
.upcoming{
    display:flex;gap:8px;margin-top:14px;
    justify-content:center;overflow-x:auto;
    scrollbar-width:none;padding:2px 0;
}
.upcoming::-webkit-scrollbar{display:none}
.up{
    flex-shrink:0;padding:8px 14px;text-align:center;
    background:var(--bg);border-radius:var(--r-sm);
}
.up-t{font-size:14px;font-weight:800;color:var(--text)}
.up-m{font-size:10px;font-weight:700;color:var(--text3);margin-top:2px}
.up-tmrw{font-size:8px;font-weight:800;color:var(--accent);margin-top:2px}

/* empty */
.empty{padding:32px 0;text-align:center}
.empty-icon{
    width:60px;height:60px;margin:0 auto 12px;border-radius:50%;
    background:var(--bg);display:flex;align-items:center;justify-content:center;
}
.empty-icon svg{width:26px;height:26px;color:var(--text3)}
.empty h3{font-size:15px;font-weight:800;color:var(--text2);margin-bottom:4px}
.empty p{font-size:12px;color:var(--text3);font-weight:600}

/* ===== SCHEDULE TABLE ===== */
.tbl{
    background:var(--card);border-radius:var(--r);
    padding:14px 12px;box-shadow:var(--shadow);
    transition:opacity .28s var(--ease);
}
.tbl.fade{opacity:0}
.tbl-head{
    display:flex;justify-content:space-between;align-items:center;
    padding:0 6px 10px;
}
.tbl-head h2{font-size:13px;font-weight:800;color:var(--text2)}
.tbl-head span{font-size:10px;color:var(--text3);font-weight:700}
.tr{
    display:flex;align-items:center;padding:8px 6px;
    border-bottom:1px solid rgba(0,0,0,.03);
}
.tr:last-child{border-bottom:none}
.tr.past{opacity:.15}
.tr.cur{
    background:var(--accent-light);margin:2px -6px;padding:8px 12px;
    border-radius:var(--r-sm);border-bottom:none;
}
.tr-h{
    width:38px;font-size:13px;font-weight:800;color:var(--text2);
    font-variant-numeric:tabular-nums;flex-shrink:0;
}
.tr-h small{font-size:9px;font-weight:600;opacity:.5}
.tr.cur .tr-h{color:var(--accent)}
.tr-m{display:flex;flex-wrap:wrap;gap:5px;flex:1}
.p{
    font-size:11px;font-weight:700;padding:3px 7px;border-radius:6px;
    color:var(--text2);font-variant-numeric:tabular-nums;
}
.p.gone{opacity:.2;text-decoration:line-through}
.p.next{background:var(--accent);color:#fff;font-weight:800;box-shadow:0 2px 8px rgba(0,0,0,.1)}
.p.live{background:var(--accent);color:#fff;font-weight:800;animation:pop 1.4s ease-in-out infinite}
@keyframes pop{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}
.tr-nil{font-size:10px;color:var(--text3);font-style:italic;font-weight:600}

/* ===== BOTTOM TAB BAR ===== */
.tabs{
    position:fixed;bottom:0;left:0;right:0;z-index:50;
    background:rgba(255,255,255,.92);
    backdrop-filter:blur(20px);-webkit-backdrop-filter:blur(20px);
    border-top:1px solid rgba(0,0,0,.06);
    padding-bottom:var(--safe-b);
    display:flex;
}
.tab{
    flex:1;display:flex;flex-direction:column;align-items:center;
    gap:2px;padding:8px 0 6px;
    border:none;background:none;font-family:inherit;
    font-size:10px;font-weight:700;color:var(--text3);
    cursor:pointer;transition:color .2s;
}
.tab.on{color:var(--accent)}
.tab svg{width:22px;height:22px;transition:color .2s}
.tab:active{opacity:.7}

/* ===== FLOATING INDICATOR ===== */
.fab{
    position:fixed;left:50%;z-index:40;
    top:calc(max(var(--safe-t),20px) + 64px);
    transform:translateX(-50%) translateY(-20px);
    opacity:0;pointer-events:none;
    padding:6px 14px;
    background:rgba(255,255,255,.95);backdrop-filter:blur(16px);-webkit-backdrop-filter:blur(16px);
    border-radius:99px;box-shadow:var(--shadow2);
    display:flex;align-items:center;gap:8px;
    transition:all .3s var(--ease);
}
.fab.show{opacity:1;transform:translateX(-50%) translateY(0);pointer-events:auto}
.fab-dir{font-size:9px;font-weight:800;color:var(--text3);padding-right:8px;border-right:1px solid rgba(0,0,0,.06)}
.fab-time{font-size:14px;font-weight:900;color:var(--accent)}
.fab-mins{font-size:11px;font-weight:700;color:var(--text2)}

/* ===== PTR ===== */
.ptr{
    position:fixed;top:calc(max(var(--safe-t),20px) + 66px);left:50%;
    transform:translateX(-50%);z-index:200;
    width:30px;height:30px;border-radius:50%;
    background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);
    display:flex;align-items:center;justify-content:center;
    opacity:0;pointer-events:none;transition:opacity .2s;
}
.ptr.show{opacity:1}
.ptr.spin svg{animation:spin .5s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== FOOTER ===== */
.foot{text-align:center;padding:20px 0 8px}
.foot img{width:40px;height:40px;border-radius:50%;opacity:.2}
</style>
</head>
<body>
<div class="station" id="app">

    <nav class="nav" id="nav">
        <div class="nav-in">
            <div class="nav-left">
                <div class="nav-icon"><img src="icon.png" alt="しろたん"></div>
                <span class="nav-title">しろたんバス</span>
            </div>
            <div class="nav-right">
                <span class="nav-clock" id="clock"></span>
                <div class="nav-badge on" id="badge"><span class="nav-dot"></span><span id="badgeTxt">運行中</span></div>
            </div>
        </div>
    </nav>

    <div class="ptr" id="ptr">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#8e8e93" stroke-width="2.5" stroke-linecap="round"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
    </div>

    <div class="fab" id="fab">
        <span class="fab-dir" id="fabDir">辻堂駅</span>
        <span class="fab-time" id="fabTime">--:--</span>
        <span class="fab-mins" id="fabMins"></span>
    </div>

    <div class="main">
        <div class="hero" id="heroCard">
            <div id="hero"></div>
        </div>

        <section class="tbl" id="tblCard">
            <div class="tbl-head"><h2>時刻表</h2><span>平日のみ運行</span></div>
            <div id="tbl"></div>
        </section>

        <div class="foot"><img src="icon.png" alt=""></div>
    </div>

    <div class="tabs">
        <button class="tab on" id="btnS" onclick="go('station')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="16" height="16" x="4" y="3" rx="2"/><path d="M4 11h16M12 3v8M8 19l-2 3M18 22l-2-3"/><circle cx="8" cy="15" r="1"/><circle cx="16" cy="15" r="1"/></svg>
            辻堂駅
        </button>
        <button class="tab" id="btnM" onclick="go('mansion')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
            マンション
        </button>
    </div>
</div>

<script>
const DATA={
    station:{
        6:[0,15,30,45],7:[0,10,15,25,30,40,45,55],8:[0,20,40],
        9:[0,20,40],10:[0,20,40],11:[0,20,40],12:[0,20,40],13:[0],14:[],
        15:[0,20,40],16:[0,20,40],17:[0,20,40],18:[0,20,40],
        19:[0,15,30,45],20:[0,20,40],21:[0,20,40],22:[0]
    },
    mansion:{
        6:[5,20,35,50],7:[5,15,20,30,35,45,50],8:[0,5,25,45],
        9:[5,25,45],10:[5,25,45],11:[5,25,45],12:[5,25,45],13:[5],14:[],
        15:[5,25,45],16:[5,25,45],17:[5,25,45],18:[5,25,45],
        19:[5,20,35,50],20:[5,25,45],21:[5,25,45],22:[5]
    }
};
const LBL={station:'辻堂駅',mansion:'マンション'};

function jpHol(y){
    const s=new Set(),a=(m,d)=>s.add(`${y}-${m}-${d}`);
    a(1,1);a(2,11);a(2,23);a(4,29);a(5,3);a(5,4);a(5,5);a(8,11);a(11,3);a(11,23);
    const nm=(mo,n)=>{const f=new Date(y,mo-1,1),d=f.getDay(),fm=d<=1?1+(1-d):1+(8-d);return fm+(n-1)*7};
    a(1,nm(1,2));a(7,nm(7,3));a(9,nm(9,3));a(10,nm(10,2));
    a(3,Math.floor(20.8431+.242194*(y-1980)-Math.floor((y-1980)/4)));
    a(9,Math.floor(23.2488+.242194*(y-1980)-Math.floor((y-1980)/4)));
    for(const h of[...s]){const[,m,d]=h.split('-').map(Number);if(new Date(y,m-1,d).getDay()===0)a(m,d+1)}
    return s;
}
let hc={};
function isOff(d){const y=d.getFullYear();if(!hc[y])hc[y]=jpHol(y);return d.getDay()===0||d.getDay()===6||hc[y].has(`${y}-${d.getMonth()+1}-${d.getDate()}`)}

let dir=localStorage.getItem('sbus-dir')||'station';
let now=new Date(),nxt=null;
const $=id=>document.getElementById(id);
const pad=n=>String(n).padStart(2,'0');

function getBuses(n=4){
    const sc=DATA[dir],h=now.getHours(),m=now.getMinutes(),o=[];
    for(let hr=h;hr<=22&&o.length<n;hr++)
        for(const mn of(sc[hr]||[])){if(hr===h&&mn<m)continue;o.push({h:hr,m:mn,now:hr===h&&mn===m});if(o.length>=n)break}
    for(let hr=6;hr<=22&&o.length<n;hr++)
        for(const mn of(sc[hr]||[])){o.push({h:hr,m:mn,tm:true});if(o.length>=n)break}
    return o;
}
function mTo(b){if(b.now)return 0;const t=new Date(now);t.setHours(b.h,b.m,0,0);if(b.tm)t.setDate(t.getDate()+1);return Math.max(0,Math.floor((t-now)/6e4))}

function go(d){
    if(d===dir)return;dir=d;localStorage.setItem('sbus-dir',d);
    $('app').className=d;
    $('btnS').className=`tab ${d==='station'?'on':''}`;
    $('btnM').className=`tab ${d==='mansion'?'on':''}`;
    if(navigator.vibrate)navigator.vibrate(8);
    fadeRender();
}

function clock(){$('clock').textContent=pad(now.getHours())+':'+pad(now.getMinutes())}

function rHero(bs){
    const off=isOff(now);
    $('badge').className=`nav-badge ${off?'off':'on'}`;
    $('badgeTxt').textContent=off?'運休日':'運行中';
    if(off){nxt=null;$('hero').innerHTML=`<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg></div><h3>本日は運休です</h3><p>平日のみ運行しています</p></div>`;return}
    if(!bs.length){nxt=null;$('hero').innerHTML=`<div class="empty"><div class="empty-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div><h3>本日の運行は終了</h3><p>始発 6:00</p></div>`;return}
    const b=bs[0],mn=mTo(b),up=bs.slice(1,4),pct=Math.max(0,100-(mn/60*100)),urg=!b.now&&mn<=3;
    nxt={t:pad(b.h)+':'+pad(b.m),mn};
    let s=`<div class="hero-mascot"><img src="icon.png" alt="しろたん"></div>
        <div class="hero-dir">${LBL[dir]}</div>
        <div class="hero-time${urg?' urgent':''}">${pad(b.h)}:${pad(b.m)}</div>
        <div class="hero-sub${urg?' urgent':''}${b.now?' now':''}">`;
    if(b.now)s+=`<b>まもなく発車</b>`;
    else s+=`あと <b>${mn}</b> 分${b.tm?'<span class="hero-tmrw">明日</span>':''}`;
    s+=`</div><div class="bar"><div class="bar-fill" style="width:${b.now?100:pct}%"></div></div>`;
    if(up.length){
        s+=`<div class="upcoming">`;
        for(const u of up){const m=mTo(u);s+=`<div class="up"><div class="up-t">${pad(u.h)}:${pad(u.m)}</div><div class="up-m">${m}分後</div>${u.tm?'<div class="up-tmrw">明日</div>':''}</div>`}
        s+=`</div>`;
    }
    $('hero').innerHTML=s;
    $('fabDir').textContent=LBL[dir];$('fabTime').textContent=nxt.t;
    $('fabMins').textContent=b.now?'まもなく':nxt.mn+'分';
}

function rTbl(bs){
    const sc=DATA[dir],h=now.getHours(),m=now.getMinutes(),nb=bs.length?bs[0]:null;
    let s='';
    for(let hr=6;hr<=22;hr++){
        const ms=sc[hr]||[];if(!ms.length&&(hr<10||hr>20))continue;
        const pa=hr<h,cu=hr===h;let c='tr';if(pa)c+=' past';if(cu)c+=' cur';
        s+=`<div class="${c}" id="r${hr}"><div class="tr-h">${hr}<small>時</small></div><div class="tr-m">`;
        if(!ms.length)s+=`<span class="tr-nil">—</span>`;
        else for(const mn of ms){
            const g=pa||(cu&&mn<m),lv=cu&&mn===m,nx=nb&&nb.h===hr&&nb.m===mn&&!nb.tm&&!lv;
            let cl='p';if(g)cl+=' gone';if(lv)cl+=' live';if(nx)cl+=' next';
            s+=`<span class="${cl}">${pad(mn)}</span>`;
        }
        s+=`</div></div>`;
    }
    $('tbl').innerHTML=s;
}

function render(){clock();const b=getBuses();rHero(b);rTbl(b)}
function fadeRender(){
    const h=$('heroCard'),t=$('tblCard');
    h.classList.add('fade');t.classList.add('fade');
    setTimeout(()=>{render();h.classList.remove('fade');t.classList.remove('fade')},280);
}
function scrollCur(){const r=$(`r${now.getHours()}`)||$(`r${now.getHours()+1}`);if(r)r.scrollIntoView({behavior:'smooth',block:'center'})}

/* floating bar */
const heroCard=$('heroCard'),fab=$('fab');
window.addEventListener('scroll',()=>{
    if(!nxt){fab.classList.remove('show');return}
    fab.classList.toggle('show',heroCard.getBoundingClientRect().bottom<60);
},{passive:true});

/* swipe */
let sx=0,sy=0;
document.addEventListener('touchstart',e=>{sx=e.touches[0].clientX;sy=e.touches[0].clientY},{passive:true});
document.addEventListener('touchend',e=>{
    const dx=e.changedTouches[0].clientX-sx,dy=e.changedTouches[0].clientY-sy;
    if(Math.abs(dx)>60&&Math.abs(dx)>Math.abs(dy)*2){
        if(dx<0&&dir==='station')go('mansion');else if(dx>0&&dir==='mansion')go('station');
    }
},{passive:true});

/* pull to refresh */
const ptr=$('ptr');let py=0,pa=false;
window.addEventListener('touchstart',e=>{if(!window.scrollY){py=e.touches[0].clientY;pa=true}},{passive:true});
window.addEventListener('touchmove',e=>{if(!pa)return;ptr.classList.toggle('show',e.touches[0].clientY-py>50&&!window.scrollY)},{passive:true});
window.addEventListener('touchend',()=>{if(!pa)return;pa=false;if(ptr.classList.contains('show')){ptr.classList.add('spin');now=new Date();render();setTimeout(()=>ptr.classList.remove('show','spin'),400)}},{passive:true});

/* init */
$('app').className=dir;
$('btnS').className=`tab ${dir==='station'?'on':''}`;
$('btnM').className=`tab ${dir==='mansion'?'on':''}`;
if('serviceWorker'in navigator)navigator.serviceWorker.register('sw.js').catch(()=>{});
render();setTimeout(scrollCur,300);
setInterval(()=>{const p=now.getMinutes();now=new Date();clock();if(now.getMinutes()!==p)render()},1000);
</script>
</body>
</html>
